<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PL5GVMRBH9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-PL5GVMRBH9');
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DS58BG5N5D">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DS58BG5N5D');
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description"
        content="Give the gift of choice with your giftcards at GenZDealZ.ai. Perfect for any occasion, and redeemable for a variety of unforgettable experiences." />
    <meta name="author" content="" />
    <link rel="icon" href="https://genzdealz.ai/icons/logo_white_old.jpg" />

    <title>GenZDealZ.ai | Transaction : Deal Chahta Hai!? Your AI-based Student Discovery App</title>

    <meta name="twitter:card" content="GenZDealZ.ai_large_image" />
    <meta name="twitter:image" content="https://genzdealz.ai/icons/logo_white_old.jpg" />
    <!-- Other meta tags -->
    <meta property="og:title"
        content="GenZDealZ.ai | Transaction : Deal Chahta Hai!? Your AI-based Student Discovery App" />
    <meta property="og:description"
        content="Give the gift of choice with your giftcards at GenZDealZ.ai. Perfect for any occasion, and redeemable for a variety of unforgettable experiences." />
    <meta property="og:image" content="https://genzdealz.ai/icons/logo_white_old.jpg" />
    <meta property="og:url" content="https://genzdealz.ai/" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
        rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <!-- Place your stylesheet here-->
    <!-- <script type="text/javascript" language="javascript">
        var versionUpdate = (new Date()).getTime();
        var link = document.createElement("link");
        link.href = "./css/style_new.css?v=" + versionUpdate;
        link.rel = "stylesheet"
        link.type = "text/css"
        document.head.appendChild(link);  
    </script> -->
    <link href="./css/style_new.css?v=1.1" rel="stylesheet" type="text/css" />
    <link href="./css/3D_card.css" rel="stylesheet" type="text/css" />


</head>

<body class="position-relative">

    <special-header></special-header>

    <div class="margin" style="margin-bottom: 125px"><span></span></div>
    <main role="main" class="container mb-3">

        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex">
                    <a href="/shared_subs" class="text-white text-decoration-none ps-3"><i
                            class="fa fa-arrow-left fs-2"></i></a>
                    <h2 class="mb-3 text-center payment-heading heading text-white mx-auto fw-bold"></h2>
                </div>
            </div>
        </div>

    </main>

    <!-- Bootstrap Modal HTML -->
    <!-- <div class="modal fade" id="paymentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content border-0 rounded-4 contact-card" style="color: white;">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="paymentModalLabel">Payment Successful</h5>
          <i id="closeButton" class="fa fa-close fs-4 ms-auto p-3 px-0 text-white" data-bs-dismiss="modal" aria-label="Close"
            style="cursor: pointer;"></i>
        </div>
        <div class="modal-body p-0 bg-transparent" id="appendData">

        </div>
        <div class="modal-footer border-0 justify-content-center">
          <a href="./giftcards" class="btn shadow w-75 rounded-5 border-0 text-white mb-3 fw-bold" style="
    background: linear-gradient( 135deg, rgb(66 151 184) 0%, rgb(0, 204, 255) 100% );
">Giftcards</a>
        </div>
      </div>
    </div>
  </div> -->
    <special-footer></special-footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
        integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/lz-string/libs/lz-string.min.js"></script> -->
    <!-- <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script> -->
    <script src="./js/headerFooter.js" type="module"></script>
    <script src="./js/dynamic_dropdown.js?v=1.1" type="module"></script>
    <!-- <script type="text/javascript" language="javascript">

        var versionUpdate = (new Date()).getTime();
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "./js/transaction.js?v=" + versionUpdate;
        document.body.appendChild(script);  
    </script> -->
    <script src="./js/3D_card.js"></script>
    <script>
        // Check if the user is authenticated
        if (localStorage.getItem('authenticated') === 'true') {
            // User is authenticated, allow access to the content
        } else {
            // User is not authenticated, redirect to the login page or handle accordingly
            window.location.href = './login';
        }
    </script>

    <script type="module">

        const baseURL = window.location.origin;
        // Extract the 'data' parameter from the URL
        // Get data from local storage
        const transactionData = localStorage.getItem("transactionData");

        if (!transactionData) {
            console.error("No transaction data found in local storage.");
            window.open(`${baseURL}/shared_subs`, "_self");
        } else {
            try {
                // Parse the JSON string
                const parsedData = JSON.parse(transactionData);
                // console.log("Retrieved Data:", parsedData);

                // Extract fields with preferred variable names
                const cfOrderId = parsedData.oid; // Cashfree Order ID
                const dealData = parsedData.dealData; // Deal data


                // Log the extracted data
                // console.log("Cashfree Order ID:", cfOrderId);
                // console.log("Operator ID:", operatorId);
                // console.log("Plan ID:", planId);
                // console.log("Mobile Number:", mNumber);
                // console.log("Plan Amount (Old):", planAmount);
                // console.log("Plan Amount (Discounted):", planAmountDiscounted);
                // console.log("Operator Name:", operatorName);
                // console.log("Operator Image:", operatorImage);
                // console.log("Circle Name:", circleName);
                // console.log("Circle ID:", circleId);
                // console.log("Data Benefit:", dataBenefit);
                // console.log("Validity:", validity);
                // console.log("Talktime:", talktime);
                // console.log("Cashback:", cashback);





                // const brandName = brndName;
                function replaceUnderscoresWithSpaces(str) {
                    return str.replace(/_/g, " ");
                }

                // Example usage:
                // let inputString = brndName;
                // let brandName = replaceUnderscoresWithSpaces(inputString);
                // Retrieve the authToken from local storage
                // const authToken = localStorage.getItem("authToken");
                // Check if the authToken is available
                // if (!authToken) {
                //   console.error("Authentication token not available");
                //   // Optionally, handle the absence of the token and inform the user
                // }
                // Retrieve user data from local storage
                const userDataString =
                    localStorage.getItem("userDataF") ||
                    localStorage.getItem("userDataA");

                if (!userDataString) {
                    console.error("User data not available in local storage");
                    // Optionally, handle the absence of user data and inform the user
                }

                // Parse user data from the string
                const userData = JSON.parse(userDataString);
                const mobileNumber =
                    userData?.number || userData.mobile_no || userData.phoneNumber; // Replace with your mobile number or get it dynamically

                // Check if there's an order ID in the URL
                if (cfOrderId) {
                    const storedOrderId = localStorage.getItem('initialOrderId');

                    if (storedOrderId) {
                        // proceedWithoutOrderId();                                  ////////////////////////// commennt later
                        // Compare the current order ID with the stored one
                        if (storedOrderId === cfOrderId) {
                            // console.log("Same order ID exists:", orderId);
                            // window.open(`${baseURL}/shared_subs`, "_self");               ////////////////////////// uncommennt later
                        } else {
                            localStorage.setItem('initialOrderId', cfOrderId);
                            // console.log("Order ID has changed.");
                            proceedWithoutOrderId();
                        }
                    } else {
                        // Store the initial order ID
                        localStorage.setItem('initialOrderId', cfOrderId);
                        // console.log("Initial order ID stored:", orderId);
                        proceedWithoutOrderId();
                    }
                } else {
                    // console.log("No order ID found in the URL.");
                }


                function proceedWithoutOrderId() {
                    // console.log("The page was not refreshed.");
                    const myHeaders0 = new Headers();
                    myHeaders0.append("order_id", cfOrderId);


                    const requestOptions = {
                        method: "GET",
                        headers: myHeaders0,
                        redirect: "follow"
                    };

                    fetch("https://flashweb.iweberp.com/api/getCashfreePaymentByOrder", requestOptions)
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response}`);
                            }
                            return response.json();
                        })
                        .then((result) => {
                            if (Array.isArray(result) && result.length > 0) {
                            localStorage.setItem("pgStatus", JSON.stringify(result[0]));
                            if (result[0].payment_status === "SUCCESS") {
                                // // API call using fetch
                                const apiURL = "https://flashweb.iweberp.com/api/purchaseGiftCard"; //update later
                                const requestHeaders = {
                                    "order_id": cfOrderId,
                                };
                                (async () => {
                                    try {
                                        const response = await fetch(apiURL, {
                                            method: "POST",
                                            headers: requestHeaders,
                                            redirect: "follow",
                                        });

                                        if (response.ok) {
                                            const responseText = await response.text();
                                            // console.log("Raw response:", responseText);
                                            const result = JSON.parse(responseText);
                                            let uid = localStorage.getItem('userId');
                                            // console.log(result);
                                            if (result && result.data && result.data.status.toLowerCase() === "success") {
                                                $(".payment-heading").text("Success! Your payment is successful.");
                                                const myHeaders = new Headers();
                                                myHeaders.append("Content-Type", "application/json");
                                                myHeaders.append("UID", uid);

                                                const raw = JSON.stringify({
                                                    "blurhash": dealData.blurhash,
                                                    "discountPercentage": dealData.discountPercentage,
                                                    "dp": dealData.dp,
                                                    "duration": dealData.duration,
                                                    "durationType": dealData.durationType,
                                                    "name": dealData.name,
                                                    "planId": dealData.planId,
                                                    "planPrice": dealData.planPrice,
                                                    "serviceId": dealData.serviceId,
                                                    "shareLimit": dealData.shareLimit,
                                                    "sharedPrice": dealData.sharedPrice,
                                                    "couponAllocationId": result.data.couponAllocationId,
                                                    "paymentId": result.data.paymentId,
                                                    "redirectURL": result.data.redirectURL,
                                                    "finalRedirectURL": `https://superflow.run/login?redirect=/shared_subscription/${result.data.shortId}&phone=${mobileNumber}`,
                                                    "shortId": result.data.shortId,
                                                    "status": result.data.status,
                                                });

                                                const requestOptions = {
                                                    method: "POST",
                                                    headers: myHeaders,
                                                    body: raw,
                                                    redirect: "follow"
                                                };

                                                fetch("https://flashweb.iweberp.com/api/save_shared_subscription", requestOptions)
                                                    .then((response) => response.text())
                                                    .then((saveResult) => {
                                                        // Ensure response is valid before redirecting
                                                        if (result.data.redirectURL) {
                                                            window.location.href = `https://superflow.run/login?redirect=/shared_subscription/${result.data.shortId}&phone=${mobileNumber}`;
                                                        } else {
                                                            $(".footer").show();
                                                            $("#overlay").hide();
                                                            // Parse the 'details' string to an object
                                                            const modalHTML = `
                                                                <div class="shadow rounded-4 p-4 bg-white" style="max-width:400px;margin:auto;text-align:center;">
                                                                <h2 class="fw-bold text-danger">Technical Error</h2>
                                                                <p class="text-third fw-semibold" style="font-size:16px;">
                                                                    <br>No URL found in result
                                                                    <br>Please contact us at 9322655704 for immediate help.
                                                                </p>
                                                                <button onclick="redirect()" class="btn shadow w-auto rounded-5 border-0 text-white mx-auto d-flex px-md-4 fw-bold" style="background: #2e3192;">OK</button>
                                                                </div>
                                                            `;

                                                            const modalContainer = document.createElement('div');
                                                            modalContainer.classList.add("error-modal");
                                                            modalContainer.innerHTML = modalHTML;

                                                            document.body.appendChild(modalContainer);
                                                            window.redirect = function () {
                                                                window.open(`${baseURL}/shared_subs`, "_self");
                                                            }
                                                        }
                                                    })
                                                    .catch((error) => {
                                                        $(".footer").show();
                                                $("#overlay").hide();
                                                // Parse the 'details' string to an object
                                                const modalHTML = `
                                                    <div class="shadow rounded-4 p-4 bg-white" style="max-width:400px;margin:auto;text-align:center;">
                                                    <h2 class="fw-bold text-danger">${error}</h2>
                                                    <p class="text-third fw-semibold" style="font-size:16px;">
                                                      <br>${error.message}  <br>Please contact us at 9322655704 for immediate help.
                                                    </p>
                                                    <br>
                                                    </div>
                                                `;

                                                const modalContainer = document.createElement('div');
                                                modalContainer.classList.add("error-modal");
                                                modalContainer.innerHTML = modalHTML;

                                                document.body.appendChild(modalContainer);
                                                window.redirect = function () {
                                                    window.open(`${baseURL}/shared_subs`, "_self");
                                                }
                                                    });
                                            } else {
                                                $(".footer").show();
                                                $("#overlay").hide();
                                                // Parse the 'details' string to an object
                                                const modalHTML = `
                                                    <div class="shadow rounded-4 p-4 bg-white" style="max-width:400px;margin:auto;text-align:center;">
                                                    <h2 class="fw-bold text-danger">Technical Error</h2>
                                                    <p class="text-third fw-semibold" style="font-size:16px;">
                                                        Please contact us at 9322655704 for immediate help.
                                                    </p>
                                                   <button onclick="redirect()" class="btn shadow w-auto rounded-5 border-0 text-white mx-auto d-flex px-md-4 fw-bold" style="background: #2e3192;">OK</button>
                                                    </div>
                                                `;

                                                const modalContainer = document.createElement('div');
                                                modalContainer.classList.add("error-modal");
                                                modalContainer.innerHTML = modalHTML;

                                                document.body.appendChild(modalContainer);
                                                window.redirect = function () {
                                                    window.open(`${baseURL}/shared_subs`, "_self");
                                                }
                                            }

                                        } else {
                                            $(".footer").show();
                                            $("#overlay").hide();

                                            const errorResponse = await response.json();
                                            const detailsObj = JSON.parse(errorResponse.details || "{}");
                                            const errorMessage = detailsObj.message || "Something went wrong";

                                            const modalHTML = `
                                                <div class="shadow rounded-4 p-4 bg-white" style="max-width:400px;margin:auto;text-align:center;">
                                                    <h2 class="fw-bold text-danger">Error</h2>
                                                    <p class="text-third fw-semibold" style="font-size:16px;">
                                                        ${errorMessage}<br>Status: ${response.status}
                                                    </p>
                                                    <button onclick="redirect()" class="btn shadow w-auto rounded-5 border-0 text-white mx-auto d-flex px-md-4 fw-bold" style="background: #2e3192;">OK</button>
                                                </div>
                                            `;

                                            const modalContainer = document.createElement('div');
                                            modalContainer.classList.add("error-modal");
                                            modalContainer.innerHTML = modalHTML;

                                            document.body.appendChild(modalContainer);
                                            window.redirect = function () {
                                                    window.open(`${baseURL}/shared_subs`, "_self");
                                                }
                                            // console.error(`Error: ${response.status} - ${response.statusText}`);
                                        }
                                    } catch (error) {
                                        console.error("Error:", error);
                                        // Store the error in localStorage
                                        localStorage.setItem("pgStatus", JSON.stringify({
                                        payment_status: "CUSTOM_SUCCESS",
                                        error_details: {
                                            error_description: error.message || "Unknown error occurred"
                                        }
                                        })); 
                                        window.open(`${baseURL}/shared_subs`, "_self");
                                    }
                                })();

                                // $(".footer, main").show();
                                // $(".overlay").hide();
                            }
                            else {
                                window.location.href = `${baseURL}/shared_subs`;
                            }
                            const myHeaders = new Headers();
                            myHeaders.append("Content-Type", "application/json");

                            const raw = JSON.stringify({
                                order_id: cfOrderId,
                                resp_str: JSON.stringify([result[0]]), // ✅ Convert result to a JSON string inside an array
                            });


                            const requestOptions = {
                                method: "POST",
                                headers: myHeaders,
                                body: raw,
                                redirect: "follow",
                            };

                            fetch("https://flashweb.iweberp.com/api/UpdateIwebPaymentStatus", requestOptions)
                                .then((response) => response.json()) // ✅ Parse response as JSON
                                .then((result) => console.log("API Response:", result))
                                .catch((error) => console.error("Error:", error));
                                } else {
                                    // Handle case when result is empty
                                    localStorage.setItem("pgStatus", JSON.stringify({
                                    payment_status: "FAILED",
                                    error_details: {
                                        error_description: "Payment cancelled or Empty response from server"
                                    }
                                    }));
                                    window.open(`${baseURL}/shared_subs`, "_self");
                                }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            // Store the error in localStorage
                            localStorage.setItem("pgStatus", JSON.stringify({
                                payment_status: "FAILED",
                                error_details: {
                                    error_description: error.message || "Unknown error occurred"
                                }
                            }));
                            window.open(`${baseURL}/shared_subs`, "_self");
                        });



                }
            } catch (error) {
                console.error("Error parsing transaction data:", error.message);
            }
        }




    </script>

    <script>

        //     $(document).ready(function(){       
        //    $('#myModal').modal('show');
        //     });
        //     document.cookie = "myCookie=myValue; SameSite=Lax";
        //     // var elements = document.querySelectorAll('.element');

        // setTimeout(function() {
        //     $('#myModal').modal('hide');
        // }, 5000);

    </script>
</body>

</html>